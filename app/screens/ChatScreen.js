import React, { useState, useEffect, useRef } from "react";
import { StyleSheet, Text, View, FlatList } from "react-native";
import io from "socket.io-client";
import * as Yup from "yup";

import Screen from "../components/Screen";
import useAuth from "../auth/useAuth";
import chatMessagesApi from "../api/chatMessages";
import { AppForm, AppFormField, SubmitButton } from "../components/form";
import ChatMessageItem from "../components/ChatMessageItem";

const validationSchema = Yup.object().shape({
  content: Yup.string().required().min(1).label("æ¶ˆæ¯"),
});

const emojis = [
  "ðŸ˜€",
  "ðŸ˜ƒ",
  "ðŸ˜„",
  "ðŸ˜",
  "ðŸ˜†",
  "ðŸ˜…",
  "ðŸ¤£",
  "ðŸ˜‚",
  "ðŸ™‚",
  "ðŸ™ƒ",
  "ðŸ˜‰",
  "ðŸ˜Š",
  "ðŸ˜‡",
  "ðŸ¥°",
  "ðŸ˜",
  "ðŸ¤©",
  "ðŸ˜˜",
  "ðŸ˜—",
  "ðŸ˜š",
  "ðŸ˜™",
  "ðŸ˜‹",
  "ðŸ˜›",
  "ðŸ˜œ",
  "ðŸ¤ª",
  "ðŸ˜",
  "ðŸ¤‘",
  "ðŸ¤—",
  "ðŸ¤­",
  "ðŸ¤«",
  "ðŸ¤”",
  "ðŸ¤",
  "ðŸ¤¨",
  "ðŸ˜",
  "ðŸ˜‘",
  "ðŸ˜¶",
  "ðŸ˜",
  "ðŸ˜’",
  "ðŸ™„",
  "ðŸ˜¬",
  "ðŸ¤¥",
  "ðŸ˜Œ",
  "ðŸ˜”",
  "ðŸ˜ª",
  "ðŸ¤¤",
  "ðŸ˜´",
  "ðŸ˜·",
  "ðŸ¤’",
  "ðŸ¤•",
  "ðŸ¤¢",
  "ðŸ¤®",
  "ðŸ¤§",
  "ðŸ¥µ",
  "ðŸ¥¶",
  "ðŸ¥´",
  "ðŸ˜µ",
  "ðŸ¤¯",
  "ðŸ¤ ",
  "ðŸ¥³",
  "ðŸ˜Ž",
  "ðŸ¤“",
  "ðŸ§",
  "ðŸ˜•",
  "ðŸ˜Ÿ",
  "ðŸ™",
  "â˜¹",
  "ðŸ˜®",
  "ðŸ˜¯",
  "ðŸ˜²",
  "ðŸ˜³",
  "ðŸ¥º",
  "ðŸ˜¦",
  "ðŸ˜§",
  "ðŸ˜¨",
  "ðŸ˜°",
  "ðŸ˜¥",
  "ðŸ˜¢",
  "ðŸ˜­",
  "ðŸ˜±",
  "ðŸ˜–",
  "ðŸ˜£",
  "ðŸ˜ž",
  "ðŸ˜“",
  "ðŸ˜©",
  "ðŸ˜«",
  "ðŸ¥±",
  "ðŸ˜¤",
  "ðŸ˜¡",
  "ðŸ˜ ",
  "ðŸ¤¬",
  "ðŸ˜ˆ",
  "ðŸ‘¿",
  "ðŸ’€",
  "â˜ ",
  "ðŸ’©",
  "ðŸ¤¡",
  "ðŸ‘¹",
  "ðŸ‘º",
  "ðŸ‘»",
  "ðŸ‘½",
  "ðŸ‘¾",
  "ðŸ¤–",
  "ðŸ˜º",
  "ðŸ˜¸",
  "ðŸ˜¹",
  "ðŸ˜»",
  "ðŸ˜¼",
  "ðŸ˜½",
  "ðŸ™€",
  "ðŸ˜¿",
  "ðŸ˜¾",
  "ðŸ’‹",
  "ðŸ‘‹",
  "ðŸ¤š",
  "ðŸ–",
  "âœ‹",
  "ðŸ––",
  "ðŸ‘Œ",
  "ðŸ¤",
  "âœŒ",
  "ðŸ¤ž",
  "ðŸ¤Ÿ",
  "ðŸ¤˜",
  "ðŸ¤™",
  "ðŸ‘ˆ",
  "ðŸ‘‰",
  "ðŸ‘†",
  "ðŸ–•",
  "ðŸ‘‡",
  "â˜",
  "ðŸ‘",
  "ðŸ‘Ž",
  "âœŠ",
  "ðŸ‘Š",
  "ðŸ¤›",
  "ðŸ¤œ",
  "ðŸ‘",
  "ðŸ™Œ",
  "ðŸ‘",
  "ðŸ¤²",
  "ðŸ¤",
  "ðŸ™",
  "âœ",
  "ðŸ’…",
  "ðŸ¤³",
  "ðŸ’ª",
  "ðŸ¦¾",
  "ðŸ¦¿",
  "ðŸ¦µ",
  "ðŸ¦¶",
  "ðŸ‘‚",
  "ðŸ¦»",
  "ðŸ‘ƒ",
  "ðŸ§ ",
  "ðŸ¦·",
  "ðŸ¦´",
  "ðŸ‘€",
  "ðŸ‘",
  "ðŸ‘…",
  "ðŸ‘„",
  "ðŸ‘¶",
  "ðŸ§’",
  "ðŸ‘¦",
  "ðŸ‘§",
  "ðŸ§‘",
  "ðŸ‘±",
  "ðŸ‘¨",
  "ðŸ§”",
  "ðŸ‘¨â€ðŸ¦°",
  "ðŸ‘¨â€ðŸ¦±",
  "ðŸ‘¨â€ðŸ¦³",
  "ðŸ‘¨â€ðŸ¦²",
  "ðŸ‘©",
  "ðŸ‘©â€ðŸ¦°",
  "ðŸ§‘â€ðŸ¦°",
  "ðŸ‘©â€ðŸ¦±",
  "ðŸ§‘â€ðŸ¦±",
  "ðŸ‘©â€ðŸ¦³",
  "ðŸ§‘â€ðŸ¦³",
  "ðŸ‘©â€ðŸ¦²",
  "ðŸ§‘â€ðŸ¦²",
  "ðŸ‘±â€â™€ï¸",
  "ðŸ‘±â€â™‚ï¸",
  "ðŸ§“",
  "ðŸ‘´",
  "ðŸ‘µ",
  "ðŸ™",
  "ðŸ™â€â™‚ï¸",
  "ðŸ™â€â™€ï¸",
  "ðŸ™Ž",
  "ðŸ™Žâ€â™‚ï¸",
  "ðŸ™Žâ€â™€ï¸",
  "ðŸ™…",
  "ðŸ™…â€â™‚ï¸",
  "ðŸ™…â€â™€ï¸",
  "ðŸ™†",
  "ðŸ™†â€â™‚ï¸",
  "ðŸ™†â€â™€ï¸",
  "ðŸ’",
  "ðŸ’â€â™‚ï¸",
  "ðŸ’â€â™€ï¸",
  "ðŸ™‹",
  "ðŸ™‹â€â™‚ï¸",
  "ðŸ™‹â€â™€ï¸",
  "ðŸ§",
  "ðŸ§â€â™‚ï¸",
  "ðŸ§â€â™€ï¸",
  "ðŸ™‡",
  "ðŸ™‡â€â™‚ï¸",
  "ðŸ™‡â€â™€ï¸",
  "ðŸ¤¦",
  "ðŸ¤¦â€â™‚ï¸",
  "ðŸ¤¦â€â™€ï¸",
  "ðŸ¤·",
  "ðŸ¤·â€â™‚ï¸",
  "ðŸ¤·â€â™€ï¸",
  "ðŸ§‘â€âš•ï¸",
  "ðŸ‘¨â€âš•ï¸",
  "ðŸ‘©â€âš•ï¸",
  "ðŸ§‘â€ðŸŽ“",
  "ðŸ‘¨â€ðŸŽ“",
  "ðŸ‘©â€ðŸŽ“",
  "ðŸ§‘â€ðŸ«",
  "ðŸ‘¨â€ðŸ«",
  "ðŸ‘©â€ðŸ«",
  "ðŸ§‘â€âš–ï¸",
  "ðŸ‘¨â€âš–ï¸",
  "ðŸ‘©â€âš–ï¸",
  "ðŸ§‘â€ðŸŒ¾",
  "ðŸ‘¨â€ðŸŒ¾",
  "ðŸ‘©â€ðŸŒ¾",
  "ðŸ§‘â€ðŸ³",
  "ðŸ‘¨â€ðŸ³",
  "ðŸ‘©â€ðŸ³",
  "ðŸ§‘â€ðŸ”§",
  "ðŸ‘¨â€ðŸ”§",
  "ðŸ‘©â€ðŸ”§",
  "ðŸ§‘â€ðŸ­",
  "ðŸ‘¨â€ðŸ­",
  "ðŸ‘©â€ðŸ­",
  "ðŸ§‘â€ðŸ’¼",
  "ðŸ‘¨â€ðŸ’¼",
  "ðŸ‘©â€ðŸ’¼",
  "ðŸ§‘â€ðŸ”¬",
  "ðŸ‘¨â€ðŸ”¬",
  "ðŸ‘©â€ðŸ”¬",
  "ðŸ§‘â€ðŸ’»",
  "ðŸ‘¨â€ðŸ’»",
  "ðŸ‘©â€ðŸ’»",
  "ðŸ§‘â€ðŸŽ¤",
  "ðŸ‘¨â€ðŸŽ¤",
  "ðŸ‘©â€ðŸŽ¤",
  "ðŸ§‘â€ðŸŽ¨",
  "ðŸ‘¨â€ðŸŽ¨",
  "ðŸ‘©â€ðŸŽ¨",
  "ðŸ§‘â€âœˆï¸",
  "ðŸ‘¨â€âœˆï¸",
  "ðŸ‘©â€âœˆï¸",
  "ðŸ§‘â€ðŸš€",
  "ðŸ‘¨â€ðŸš€",
  "ðŸ‘©â€ðŸš€",
  "ðŸ§‘â€ðŸš’",
  "ðŸ‘¨â€ðŸš’",
  "ðŸ‘©â€ðŸš’",
  "ðŸ‘®",
  "ðŸ‘®â€â™‚ï¸",
  "ðŸ‘®â€â™€ï¸",
  "ðŸ•µ",
  "ðŸ•µï¸â€â™‚ï¸",
  "ðŸ•µï¸â€â™€ï¸",
  "ðŸ’‚",
  "ðŸ’‚â€â™‚ï¸",
  "ðŸ’‚â€â™€ï¸",
  "ðŸ‘·",
  "ðŸ‘·â€â™‚ï¸",
  "ðŸ‘·â€â™€ï¸",
  "ðŸ¤´",
  "ðŸ‘¸",
  "ðŸ‘³",
  "ðŸ‘³â€â™‚ï¸",
  "ðŸ‘³â€â™€ï¸",
  "ðŸ‘²",
  "ðŸ§•",
  "ðŸ¤µ",
  "ðŸ‘°",
  "ðŸ¤°",
  "ðŸ¤±",
  "ðŸ§‘â€",
  "ðŸ‘¼",
  "ðŸŽ…",
  "ðŸ¤¶",
  "ðŸ¦¸",
  "ðŸ¦¸â€â™‚ï¸",
  "ðŸ¦¸â€â™€ï¸",
  "ðŸ¦¹",
  "ðŸ¦¹â€â™‚ï¸",
  "ðŸ¦¹â€â™€ï¸",
  "ðŸ§™",
  "ðŸ§™â€â™‚ï¸",
  "ðŸ§™â€â™€ï¸",
  "ðŸ§š",
  "ðŸ§šâ€â™‚ï¸",
  "ðŸ§šâ€â™€ï¸",
  "ðŸ§›",
  "ðŸ§›â€â™‚ï¸",
  "ðŸ§›â€â™€ï¸",
  "ðŸ§œ",
  "ðŸ§œâ€â™‚ï¸",
  "ðŸ§œâ€â™€ï¸",
  "ðŸ§",
  "ðŸ§â€â™‚ï¸",
  "ðŸ§â€â™€ï¸",
  "ðŸ§ž",
  "ðŸ§žâ€â™‚ï¸",
  "ðŸ§žâ€â™€ï¸",
  "ðŸ§Ÿ",
  "ðŸ§Ÿâ€â™‚ï¸",
  "ðŸ§Ÿâ€â™€ï¸",
  "ðŸ’†",
  "ðŸ’†â€â™‚ï¸",
  "ðŸ’†â€â™€ï¸",
  "ðŸ’‡",
  "ðŸ’‡â€â™‚ï¸",
  "ðŸ’‡â€â™€ï¸",
  "ðŸš¶",
  "ðŸš¶â€â™‚ï¸",
  "ðŸš¶â€â™€ï¸",
  "ðŸ§",
  "ðŸ§â€â™‚ï¸",
  "ðŸ§â€â™€ï¸",
  "ðŸ§Ž",
  "ðŸ§Žâ€â™‚ï¸",
  "ðŸ§Žâ€â™€ï¸",
  "ðŸ§‘â€ðŸ¦¯",
  "ðŸ‘¨â€ðŸ¦¯",
  "ðŸ‘©â€ðŸ¦¯",
  "ðŸ§‘â€ðŸ¦¼",
  "ðŸ‘¨â€ðŸ¦¼",
  "ðŸ‘©â€ðŸ¦¼",
  "ðŸ§‘â€ðŸ¦½",
  "ðŸ‘¨â€ðŸ¦½",
  "ðŸ‘©â€ðŸ¦½",
  "ðŸƒ",
  "ðŸƒâ€â™‚ï¸",
  "ðŸƒâ€â™€ï¸",
  "ðŸ’ƒ",
  "ðŸ•º",
  "ðŸ•´",
  "ðŸ‘¯",
  "ðŸ‘¯â€â™‚ï¸",
  "ðŸ‘¯â€â™€ï¸",
  "ðŸ§–",
  "ðŸ§–â€â™‚ï¸",
  "ðŸ§–â€â™€ï¸",
  "ðŸ§˜",
  "ðŸ§‘â€ðŸ¤â€ðŸ§‘",
  "ðŸ‘­",
  "ðŸ‘«",
  "ðŸ‘¬",
  "ðŸ’",
  "ðŸ‘©â€â¤ï¸â€ðŸ’‹â€ðŸ‘¨",
  "ðŸ‘¨â€â¤ï¸â€ðŸ’‹â€ðŸ‘¨",
  "ðŸ‘©â€â¤ï¸â€ðŸ’‹â€ðŸ‘©",
  "ðŸ’‘",
  "ðŸ‘©â€â¤ï¸â€ðŸ‘¨",
  "ðŸ‘¨â€â¤ï¸â€ðŸ‘¨",
  "ðŸ‘©â€â¤ï¸â€ðŸ‘©",
  "ðŸ‘ª",
  "ðŸ‘¨â€ðŸ‘©â€ðŸ‘¦",
  "ðŸ‘¨â€ðŸ‘©â€ðŸ‘§",
  "ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦",
  "ðŸ‘¨â€ðŸ‘©â€ðŸ‘¦â€ðŸ‘¦",
  "ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘§",
  "ðŸ‘¨â€ðŸ‘¨â€ðŸ‘¦",
  "ðŸ‘¨â€ðŸ‘¨â€ðŸ‘§",
  "ðŸ‘¨â€ðŸ‘¨â€ðŸ‘§â€ðŸ‘¦",
  "ðŸ‘¨â€ðŸ‘¨â€ðŸ‘¦â€ðŸ‘¦",
  "ðŸ‘¨â€ðŸ‘¨â€ðŸ‘§â€ðŸ‘§",
  "ðŸ‘©â€ðŸ‘©â€ðŸ‘¦",
  "ðŸ‘©â€ðŸ‘©â€ðŸ‘§",
  "ðŸ‘©â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦",
  "ðŸ‘©â€ðŸ‘©â€ðŸ‘¦â€ðŸ‘¦",
  "ðŸ‘©â€ðŸ‘©â€ðŸ‘§â€ðŸ‘§",
  "ðŸ‘¨â€ðŸ‘¦",
  "ðŸ‘¨â€ðŸ‘¦â€ðŸ‘¦",
  "ðŸ‘¨â€ðŸ‘§",
  "ðŸ‘¨â€ðŸ‘§â€ðŸ‘¦",
  "ðŸ‘¨â€ðŸ‘§â€ðŸ‘§",
  "ðŸ‘©â€ðŸ‘¦",
  "ðŸ‘©â€ðŸ‘¦â€ðŸ‘¦",
  "ðŸ‘©â€ðŸ‘§",
  "ðŸ‘©â€ðŸ‘§â€ðŸ‘¦",
  "ðŸ‘©â€ðŸ‘§â€ðŸ‘§",
  "ðŸ—£",
  "ðŸ‘¤",
  "ðŸ‘¥",
  "ðŸ‘£",
  "ðŸ§³",
  "ðŸŒ‚",
  "â˜‚",
  "ðŸŽƒ",
  "ðŸ§µ",
  "ðŸ§¶",
  "ðŸ‘“",
  "ðŸ•¶",
  "ðŸ¥½",
  "ðŸ¥¼",
  "ðŸ¦º",
  "ðŸ‘”",
  "ðŸ‘•",
  "ðŸ‘–",
  "ðŸ§£",
  "ðŸ§¤",
  "ðŸ§¥",
  "ðŸ§¦",
  "ðŸ‘—",
  "ðŸ‘˜",
  "ðŸ¥»",
  "ðŸ©±",
  "ðŸ©²",
  "ðŸ©³",
  "ðŸ‘™",
  "ðŸ‘š",
  "ðŸ‘›",
  "ðŸ‘œ",
  "ðŸ‘",
  "ðŸŽ’",
  "ðŸ‘ž",
  "ðŸ‘Ÿ",
  "ðŸ¥¾",
  "ðŸ¥¿",
  "ðŸ‘ ",
  "ðŸ‘¡",
  "ðŸ©°",
  "ðŸ‘¢",
  "ðŸ‘‘",
  "ðŸ‘’",
  "ðŸŽ©",
  "ðŸŽ“",
  "ðŸ§¢",
  "â›‘",
  "ðŸ’„",
  "ðŸ’",
  "ðŸ’¼",
  "ðŸ©¸",
];

const emojisData = emojis.map((emoji) => ({ text: emoji }));

export default function ChatScreen({ route }) {
  const [messages, setMessages] = useState([]);
  const [count, setCount] = useState(0);
  const scrollView = useRef();
  const { to, name, friendAvatar } = route.params;
  const { user } = useAuth();
  const from = user._id;

  function initIO() {
    if (!io.socket) {
      return io("http://192.168.31.101:3000");
    }
  }

  const getMessagesList = async () => {
    const result = await chatMessagesApi.getMessagesList();
    const userChat_id = [from, to].sort().join("_");
    const our = result.data.data.messagesData.filter(
      (message) => message.chat_id === userChat_id
    );
    setMessages(our);
  };

  const handleSubmit = (content, { resetForm }) => {
    const socket = initIO();
    socket.emit("sendMessage", { from, to, content });
    setTimeout(() => {
      setCount(count + 1);
    }, 200);
    resetForm();
  };

  useEffect(() => {
    getMessagesList();
  }, [count]);
  return (
    <Screen>
      <View style={{ height: "90%" }}>
        <FlatList
          ref={scrollView}
          onContentSizeChange={() => scrollView.current.scrollToEnd()}
          showsVerticalScrollIndicator={false}
          data={messages}
          keyExtractor={(message) => message._id.toString()}
          renderItem={({ item }) => {
            console.log(item);
            if (item.from === from) {
              return (
                <ChatMessageItem
                  isMe={true}
                  image={user.avatar}
                  content={item.content}
                />
              );
            } else {
              return (
                <ChatMessageItem
                  isMe={false}
                  image={friendAvatar}
                  content={item.content}
                />
              );
            }
          }}
          initialScrollIndex={messages.length > 10 ? messages.length - 1 : 0}
          getItemLayout={(data, index) => ({
            length: 100,
            offset: 100 * index,
            index,
          })}
        />
      </View>
      <View style={styles.container}>
        <AppForm initialValues={validationSchema} onSubmit={handleSubmit}>
          <AppFormField
            name='content'
            autoCapitalize='none'
            autoCurrent={false}
            multiline={true}
            width='80%'
          />
          <View style={styles.button}>
            <SubmitButton title='å‘é€' />
          </View>
        </AppForm>
      </View>
    </Screen>
  );
}

const styles = StyleSheet.create({
  container: {
    flexDirection: "row",
    marginVertical: 10,
    marginLeft: 10,
    marginRight: 15,
    position: "absolute",
    bottom: -10,
    backgroundColor: "white",
  },
  button: {
    width: "20%",
    marginLeft: 5,
  },
});
